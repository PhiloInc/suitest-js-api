"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,s=1,n=arguments.length;s<n;s++)for(var a in e=arguments[s])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)},__rest=this&&this.__rest||function(t,e){var s={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(s[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(t);a<n.length;a++)e.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(t,n[a])&&(s[n[a]]=t[n[a]])}return s};Object.defineProperty(exports,"__esModule",{value:!0}),exports.translateCondition=exports.sortNetworkInfo=exports.translateElementProperty=void 0;var smst_1=require("@suitest/smst"),utils_1=require("./utils"),comparator_1=require("./comparator"),translateApplicationExitedCondition=function(t,e){return smst_1.jsx("condition",{title:smst_1.jsx("text",null,"Application has exited"),status:utils_1.mapStatus(null==e?void 0:e.result,t)})},translateCurrentLocationCondition=function(t,e,s,n){var a="matches"===t.type;return smst_1.jsx("condition",{title:smst_1.jsx("text",null,"Current location")},smst_1.jsx("props",null,a?utils_1.translateCodeProp(smst_1.jsx("text",null,"current location"),t.val,s,comparator_1.translateComparator(t.type),utils_1.mapStatus(null==n?void 0:n.result,e)):smst_1.jsx("prop",{name:smst_1.jsx("text",null,"current location"),expectedValue:utils_1.formatVariables(t.val,null==s?void 0:s.configVariables),comparator:comparator_1.translateComparator(t.type),status:utils_1.mapStatus(null==n?void 0:n.result,e),actualValue:null==n?void 0:n.actualValue})))},translateCookieCondition=function(t,e,s,n){var a=smst_1.jsx("fragment",null,"cookie ",smst_1.jsx("subject",null,t.subject.val));return"exists"===t.type?smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,a," exists")}):"!exists"===t.type?smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,a," does not exist")}):"matches"===t.type?smst_1.jsx("condition",{title:a},smst_1.jsx("props",null,utils_1.translateCodeProp(smst_1.jsx("subject",null,t.subject.val),t.val,s,t.type,utils_1.mapStatus(null==n?void 0:n.result,e)))):smst_1.jsx("condition",{title:a},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("subject",null,t.subject.val),comparator:comparator_1.translateComparator(t.type),expectedValue:utils_1.formatVariables(t.val,null==s?void 0:s.configVariables),actualValue:null==n?void 0:n.actualValue,status:utils_1.mapStatus(null==n?void 0:n.result,e)})))};exports.translateElementProperty=function(t){switch(t){case"videoUrl":return"video URL";case"url":return"URL";case"color":return"text color";case"zIndex":return"z-index";case"automationId":return"automation ID";case"scaleX":return"scale X";case"scaleY":return"scale Y";case"translationX":return"translation X";case"translationY":return"translation Y";case"pivotX":return"pivot X";case"pivotY":return"pivot Y";case"tagInt":return"tag";case"fontURI":return"font URI";case"proposalURL":return"proposal URL";default:return t.replace(/([A-Z+])/g,(function(t,e){return" "+e.toLowerCase()}))}};var assertUnknownElementCondition=function(t){throw new Error("Unknown element condition type: "+JSON.stringify(t))},translateElementName=function(t,e){var s=function(e){return"val"in t&&!Array.isArray(t.val)&&!!t.val[e]};return"video"===t.type||s("video")?smst_1.jsx("subject",null,"video"):"psVideo"===t.type||s("psVideo")?smst_1.jsx("subject",null,"PlayStation 4 video"):"elementId"in t?e&&e[t.elementId]?smst_1.jsx("subject",null,e[t.elementId].name):t.nameHint?smst_1.jsx("subject",null,t.nameHint):smst_1.jsx("fragment",null,"Unknown element (",smst_1.jsx("subject",null,t.elementId.length>12?t.elementId.slice(0,4)+"..."+t.elementId.slice(-4):t.elementId),")"):"apiId"in t?smst_1.jsx("subject",null,t.apiId):smst_1.jsx("subject",null,stringifyCustomElementSubjectVal(t.val))},stringifyCustomElementSubjectVal=function(t){if(Array.isArray(t))return t.map(stringifyCustomElementSubjectVal).join(" -> ");if(t.active)return"active element";if(t.handle)return'element by handle "'+t.handle+'"';if("string"==typeof t.linkText)return'link with "'+t.linkText+'" text';if("string"==typeof t.partialLinkText)return'link containing "'+t.partialLinkText+'" text';var e=t.ifMultipleFoundReturn,s=__rest(t,["ifMultipleFoundReturn"]),n=Object.entries(s);return 1===n.length?n[0][1]:JSON.stringify(__assign(__assign({},s),{index:null!=e?e:1}))},translateElementCondition=function(t,e,s,n,a){var r=translateElementName(t.subject,n);switch(t.type){case"exists":return smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,r," exists"),status:utils_1.mapStatus(null==a?void 0:a.result,e)});case"!exists":return smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,r," does not exist"),status:utils_1.mapStatus(null==a?void 0:a.result,e)});case"visible":return smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,r," is visible"),status:utils_1.mapStatus(null==a?void 0:a.result,e)});case"!visible":return smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,r," is not visible"),status:utils_1.mapStatus(null==a?void 0:a.result,e)});case"matches":return smst_1.jsx("condition",{title:smst_1.jsx("fragment",null,r," matches JavaScript"),status:utils_1.mapStatus(null==a?void 0:a.result,e)},smst_1.jsx("props",null,utils_1.translateCodeProp(r,t.val,s,comparator_1.translateComparator(t.type),utils_1.mapStatus(null==a?void 0:a.result,e))));case"has":return smst_1.jsx("condition",{title:r,status:utils_1.mapStatus(null==a?void 0:a.result,e)},utils_1.shouldElMatchDetailsBeHidden(a)?null:smst_1.jsx("props",null,t.expression.map((function(t,e){var n=a&&"expression"in a?a.expression[e]:void 0,r=n&&"actualValue"in n?n.actualValue:void 0;n&&"message"in n&&"missingProperty"===n.message.code?r="property missing":n&&"message"in n&&"wrongExpression"===n.message.code&&(r="wrong format");var o=t.inherited?n&&"expectedValue"in n?n.expectedValue:"[element repository value]":t.val;return smst_1.jsx("prop",{name:smst_1.jsx("text",null,exports.translateElementProperty(t.property)),comparator:comparator_1.translateComparator(t.type),expectedValue:utils_1.formatVariables(o+("+-"===t.type?" Â± "+t.deviation:""),null==s?void 0:s.configVariables),actualValue:r,status:null==n?void 0:n.result})}))));default:return assertUnknownElementCondition(t)}},translatePSVideoCondition=function(t,e,s){var n=smst_1.jsx("fragment",null,"PlayStation 4 video had no error ","all"===t.searchStrategy?"for any source":"for current source");return smst_1.jsx("condition",{title:n,status:utils_1.mapStatus(null==s?void 0:s.result,e)})},translateJavaScriptExpressionCondition=function(t,e,s,n){var a;return smst_1.jsx("condition",{title:smst_1.jsx("text",null,"JavaScript expression")},smst_1.jsx("props",null,utils_1.translateCodeProp(smst_1.jsx("text",null,"expression"),null!==(a=t.subject.val)&&void 0!==a?a:"[NOT SPECIFIED]",s,"","JavaScriptError"===(null==n?void 0:n.errorType)?"fail":utils_1.mapStatus(null==n?void 0:n.result)),smst_1.jsx("prop",{name:smst_1.jsx("text",null,"expected result"),expectedValue:t.val?utils_1.formatVariables(t.val,null==s?void 0:s.configVariables):smst_1.jsx("text",null,"[NOT SPECIFIED]"),actualValue:null==n?void 0:n.actualValue,comparator:comparator_1.translateComparator(t.type),status:utils_1.mapStatus(null==n?void 0:n.result,e)})))},translateNetworkInfo=function(t,e,s){return void 0===s&&(s=[]),function(n){var a=n.name,r=n.compare,o=n.val,l=s.find((function(e){return"noUriFound"!==e.type&&(e.message===(t?"request":"response")&&("name"in e?e.name:"@"+e.type)===a)})),i=smst_1.jsx("prop",{name:smst_1.jsx("fragment",null,t?"request ":"response ",a.startsWith("@")?smst_1.jsx("text",null,a.slice(1)):smst_1.jsx("fragment",null,"header ",utils_1.formatVariables(a,null==e?void 0:e.configVariables))),comparator:comparator_1.translateComparator(r),expectedValue:utils_1.formatVariables(String(o),null==e?void 0:e.configVariables)});return s.length>1&&"noUriFound"!==s[0].type&&(i.status=l?"fail":"success"),l&&"noUriFound"!==l.type?("notMatched"===l.reason?i.actualValue=""===l.actualValue?"[EMPTY STRING]":l.actualValue:"notFound"===l.reason?i.actualValue="not found":i.actualValue="unknown",i):i}};exports.sortNetworkInfo=function(t,e){return["@method","@status"].includes(t.name)?-1:["@method","@status"].includes(e.name)||"@body"===t.name?1:"@body"===e.name?-1:t.name>e.name?1:-1};var translateNetworkRequestCondition=function(t,e,s,n){var a,r,o,l,i="queryFailed"===(null==n?void 0:n.errorType)&&"errors"in n?n.errors:[],u=null!==(r=null===(a=t.subject.requestInfo)||void 0===a?void 0:a.sort(exports.sortNetworkInfo).map(translateNetworkInfo(!0,s,i)))&&void 0!==r?r:[],c=null!==(l=null===(o=t.subject.responseInfo)||void 0===o?void 0:o.sort(exports.sortNetworkInfo).map(translateNetworkInfo(!1,s,i)))&&void 0!==l?l:[],m=u.concat(c);return smst_1.jsx("condition",{title:smst_1.jsx("text",null,"network request ","made"===t.type?"was made":"was not made"," ","all"===t.searchStrategy?"in entire network log":"excluding previously matched requests")},smst_1.jsx("props",null,smst_1.jsx("prop",{name:smst_1.jsx("text",null,"URL"),comparator:comparator_1.translateComparator(t.subject.compare),expectedValue:utils_1.formatVariables(t.subject.val,null==s?void 0:s.configVariables),status:n&&"errors"in n&&n.errors.find((function(t){return"noUriFound"===t.type}))?e?"success":"fail":void 0}),m))},assertUnknownConditionSubject=function(t){throw new Error("Unknown condition subject: "+JSON.stringify(t))};exports.translateCondition=function(t,e,s,n,a){switch(t.subject.type){case"element":case"video":return translateElementCondition(t,e,s,n,a);case"psVideo":return"hadNoError"===t.type?translatePSVideoCondition(t,e,a):translateElementCondition(t,e,s,n,a);case"javascript":return translateJavaScriptExpressionCondition(t,e,s,a);case"location":return translateCurrentLocationCondition(t,e,s,a);case"cookie":return translateCookieCondition(t,e,s,a);case"network":return translateNetworkRequestCondition(t,e,s,a);case"application":return translateApplicationExitedCondition(e,a);default:return assertUnknownConditionSubject(t.subject)}};